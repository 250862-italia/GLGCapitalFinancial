require('dotenv').config({ path: '.env.local' });

const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_ANON_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
const BASE_URL = 'http://localhost:3001';

async function makeRequest(url, options = {}) {
  try {
    const response = await fetch(url, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    const data = await response.json().catch(() => ({}));
    return { response, data, error: null };
  } catch (error) {
    return { response: null, data: null, error: error.message };
  }
}

async function comprehensiveAnalysis() {
  console.log('üîç COMPREHENSIVE SITE ANALYSIS\n');
  console.log('=' .repeat(50));
  
  const issues = [];
  const warnings = [];
  const successes = [];

  // 1. Environment Check
  console.log('\n1Ô∏è‚É£ ENVIRONMENT CHECK');
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    issues.push('‚ùå Missing Supabase environment variables');
    console.log('‚ùå Missing Supabase environment variables');
  } else {
    successes.push('‚úÖ Supabase environment variables found');
    console.log('‚úÖ Supabase environment variables found');
  }

  // 2. Server Connectivity
  console.log('\n2Ô∏è‚É£ SERVER CONNECTIVITY');
  const { response: healthResponse, error: healthError } = await makeRequest(`${BASE_URL}/api/health`);
  
  if (healthError) {
    issues.push(`‚ùå Server not responding: ${healthError}`);
    console.log(`‚ùå Server not responding: ${healthError}`);
  } else if (healthResponse.status !== 200) {
    issues.push(`‚ùå Health check failed: ${healthResponse.status}`);
    console.log(`‚ùå Health check failed: ${healthResponse.status}`);
  } else {
    successes.push('‚úÖ Server is running and healthy');
    console.log('‚úÖ Server is running and healthy');
  }

  // 3. CSRF Token System
  console.log('\n3Ô∏è‚É£ CSRF TOKEN SYSTEM');
  const { response: csrfResponse, data: csrfData, error: csrfError } = await makeRequest(`${BASE_URL}/api/csrf`);
  
  if (csrfError) {
    issues.push(`‚ùå CSRF API error: ${csrfError}`);
    console.log(`‚ùå CSRF API error: ${csrfError}`);
  } else if (csrfResponse.status !== 200) {
    issues.push(`‚ùå CSRF API failed: ${csrfResponse.status}`);
    console.log(`‚ùå CSRF API failed: ${csrfResponse.status}`);
  } else if (!csrfData.token) {
    issues.push('‚ùå CSRF token not generated');
    console.log('‚ùå CSRF token not generated');
  } else {
    successes.push('‚úÖ CSRF token system working');
    console.log('‚úÖ CSRF token system working');
  }

  // 4. Database Connection
  console.log('\n4Ô∏è‚É£ DATABASE CONNECTION');
  const { response: dbResponse, data: dbData, error: dbError } = await makeRequest(`${BASE_URL}/api/test-supabase`);
  
  if (dbError) {
    issues.push(`‚ùå Database connection error: ${dbError}`);
    console.log(`‚ùå Database connection error: ${dbError}`);
  } else if (dbResponse.status !== 200) {
    issues.push(`‚ùå Database test failed: ${dbResponse.status}`);
    console.log(`‚ùå Database test failed: ${dbResponse.status}`);
  } else {
    successes.push('‚úÖ Database connection working');
    console.log('‚úÖ Database connection working');
  }

  // 5. AUTHENTICATION SYSTEM
  console.log('\n5Ô∏è‚É£ AUTHENTICATION SYSTEM');
  const testEmail = `test_analysis_${Date.now()}@example.com`;
  const testPassword = 'TestPassword123!';
  let loginResponse = null; // Declare outside the if block
  
  // Get a fresh CSRF token for authentication tests
  const { response: authCsrfResponse, data: authCsrfData, error: authCsrfError } = await makeRequest(`${BASE_URL}/api/csrf`);
  
  if (authCsrfError || !authCsrfData?.token) {
    issues.push('‚ùå Cannot get CSRF token for authentication tests');
    console.log('‚ùå Cannot get CSRF token for authentication tests');
  } else {
    // Registration test
    const { response: regResponse, data: regData, error: regError } = await makeRequest(`${BASE_URL}/api/auth/register`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': authCsrfData.token
      },
      body: JSON.stringify({
        email: testEmail,
        password: testPassword,
        firstName: 'Test',
        lastName: 'Analysis',
        country: 'Italy'
      })
    });

    if (regError) {
      issues.push(`‚ùå Registration API error: ${regError}`);
      console.log(`‚ùå Registration API error: ${regError}`);
    } else if (regResponse.status !== 200) {
      issues.push(`‚ùå Registration failed: ${regResponse.status} - ${JSON.stringify(regData)}`);
      console.log(`‚ùå Registration failed: ${regResponse.status} - ${JSON.stringify(regData)}`);
    } else {
      successes.push('‚úÖ Registration system working');
      console.log('‚úÖ Registration system working');
    }

    // Login test
    const loginResult = await makeRequest(`${BASE_URL}/api/auth/login`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': authCsrfData.token
      },
      body: JSON.stringify({
        email: testEmail,
        password: testPassword
      })
    });
    
    loginResponse = loginResult.response; // Assign to outer variable
    const { data: loginData, error: loginError } = loginResult;

    if (loginError) {
      issues.push(`‚ùå Login API error: ${loginError}`);
      console.log(`‚ùå Login API error: ${loginError}`);
    } else if (loginResponse.status !== 200) {
      issues.push(`‚ùå Login failed: ${loginResponse.status} - ${JSON.stringify(loginData)}`);
      console.log(`‚ùå Login failed: ${loginResponse.status} - ${JSON.stringify(loginData)}`);
    } else {
      successes.push('‚úÖ Login system working');
      console.log('‚úÖ Login system working');
    }
  }

  // 6. Page Accessibility (without auth)
  console.log('\n6Ô∏è‚É£ PAGE ACCESSIBILITY (PUBLIC)');
  const publicPages = [
    '/',
    '/about',
    '/contact',
    '/login',
    '/register',
    '/equity-pledge',
    '/landing'
  ];

  for (const page of publicPages) {
    const { response: pageResponse, error: pageError } = await makeRequest(`${BASE_URL}${page}`);
    
    if (pageError) {
      issues.push(`‚ùå Page ${page} not accessible: ${pageError}`);
      console.log(`‚ùå Page ${page} not accessible: ${pageError}`);
    } else if (pageResponse.status !== 200) {
      issues.push(`‚ùå Page ${page} failed: ${pageResponse.status}`);
      console.log(`‚ùå Page ${page} failed: ${pageResponse.status}`);
    } else {
      successes.push(`‚úÖ Page ${page} accessible`);
      console.log(`‚úÖ Page ${page} accessible`);
    }
  }

  // 7. Protected Pages (with auth)
  console.log('\n7Ô∏è‚É£ PROTECTED PAGES (WITH AUTH)');
  const protectedPages = [
    '/profile',
    '/dashboard',
    '/dashboard/investments',
    '/investments',
    '/notes'
  ];

  for (const page of protectedPages) {
    const { response: pageResponse, error: pageError } = await makeRequest(`${BASE_URL}${page}`, {
      headers: {
        'Cookie': loginResponse?.headers?.get('set-cookie') || ''
      }
    });
    
    if (pageError) {
      warnings.push(`‚ö†Ô∏è Protected page ${page} error: ${pageError}`);
      console.log(`‚ö†Ô∏è Protected page ${page} error: ${pageError}`);
    } else if (pageResponse.status === 401 || pageResponse.status === 403) {
      successes.push(`‚úÖ Page ${page} properly protected`);
      console.log(`‚úÖ Page ${page} properly protected`);
    } else if (pageResponse.status !== 200) {
      warnings.push(`‚ö†Ô∏è Protected page ${page} unexpected status: ${pageResponse.status}`);
      console.log(`‚ö†Ô∏è Protected page ${page} unexpected status: ${pageResponse.status}`);
    } else {
      successes.push(`‚úÖ Protected page ${page} accessible with auth`);
      console.log(`‚úÖ Protected page ${page} accessible with auth`);
    }
  }

  // 8. API Endpoints
  console.log('\n8Ô∏è‚É£ API ENDPOINTS');
  const apiEndpoints = [
    { path: '/api/health', method: 'GET' },
    { path: '/api/csrf', method: 'GET' },
    { path: '/api/test-supabase', method: 'GET' },
    { path: '/api/auth/register', method: 'POST', body: { email: 'test@example.com', password: 'test123', firstName: 'Test', lastName: 'User', country: 'Italy' } },
    { path: '/api/auth/login', method: 'POST', body: { email: 'test@example.com', password: 'test123' } },
    { path: '/api/auth/check', method: 'GET' },
    { path: '/api/profile/update', method: 'POST', body: { user_id: '00000000-0000-0000-0000-000000000000', first_name: 'Test' } },
    { path: '/api/profile/upload-photo', method: 'POST', body: { user_id: '00000000-0000-0000-0000-000000000000' } },
    { path: '/api/investments', method: 'GET' },
    { path: '/api/notes', method: 'GET' }
  ];

  for (const endpoint of apiEndpoints) {
    const options = {
      method: endpoint.method,
      headers: {}
    };
    
    // Only add CSRF token for POST requests that need it
    if (endpoint.method === 'POST' && csrfData?.token) {
      options.headers['X-CSRF-Token'] = csrfData.token;
    }
    
    if (endpoint.body) {
      options.body = JSON.stringify(endpoint.body);
    }
    
    const { response: apiResponse, error: apiError } = await makeRequest(`${BASE_URL}${endpoint.path}`, options);
    
    if (apiError) {
      issues.push(`‚ùå API ${endpoint.path} error: ${apiError}`);
      console.log(`‚ùå API ${endpoint.path} error: ${apiError}`);
    } else if (apiResponse.status >= 500) {
      issues.push(`‚ùå API ${endpoint.path} server error: ${apiResponse.status}`);
      console.log(`‚ùå API ${endpoint.path} server error: ${apiResponse.status}`);
    } else if (apiResponse.status >= 400) {
      warnings.push(`‚ö†Ô∏è API ${endpoint.path} client error: ${apiResponse.status}`);
      console.log(`‚ö†Ô∏è API ${endpoint.path} client error: ${apiResponse.status}`);
    } else {
      successes.push(`‚úÖ API ${endpoint.path} working`);
      console.log(`‚úÖ API ${endpoint.path} working`);
    }
  }

  // 9. File System Check
  console.log('\n9Ô∏è‚É£ FILE SYSTEM CHECK');
  const criticalFiles = [
    'app/layout.tsx',
    'app/page.tsx',
    'app/profile/page.tsx',
    'app/dashboard/page.tsx',
    'app/api/auth/login/route.ts',
    'app/api/auth/register/route.ts',
    'lib/supabase.ts',
    'lib/csrf-client.ts',
    'lib/safe-router.ts',
    'hooks/use-auth.ts',
    'components/Navigation.tsx',
    'components/Footer.tsx'
  ];

  for (const file of criticalFiles) {
    if (fs.existsSync(file)) {
      successes.push(`‚úÖ File ${file} exists`);
      console.log(`‚úÖ File ${file} exists`);
    } else {
      issues.push(`‚ùå Critical file missing: ${file}`);
      console.log(`‚ùå Critical file missing: ${file}`);
    }
  }

  // 10. Build Issues Check
  console.log('\nüîü BUILD ISSUES CHECK');
  const buildFiles = [
    '.next',
    'node_modules',
    'package.json',
    'next.config.js',
    'tsconfig.json'
  ];

  for (const file of buildFiles) {
    if (fs.existsSync(file)) {
      successes.push(`‚úÖ Build file ${file} exists`);
      console.log(`‚úÖ Build file ${file} exists`);
    } else {
      issues.push(`‚ùå Build file missing: ${file}`);
      console.log(`‚ùå Build file missing: ${file}`);
    }
  }

  // Summary
  console.log('\n' + '='.repeat(50));
  console.log('üìä ANALYSIS SUMMARY');
  console.log('='.repeat(50));
  
  console.log(`\n‚úÖ SUCCESSES: ${successes.length}`);
  console.log(`‚ö†Ô∏è WARNINGS: ${warnings.length}`);
  console.log(`‚ùå ISSUES: ${issues.length}`);
  
  if (issues.length > 0) {
    console.log('\nüö® CRITICAL ISSUES:');
    issues.forEach(issue => console.log(`  ${issue}`));
  }
  
  if (warnings.length > 0) {
    console.log('\n‚ö†Ô∏è WARNINGS:');
    warnings.forEach(warning => console.log(`  ${warning}`));
  }
  
  console.log('\nüéØ RECOMMENDATIONS:');
  if (issues.length === 0 && warnings.length === 0) {
    console.log('  ‚úÖ Site is working correctly!');
  } else {
    if (issues.length > 0) {
      console.log('  üîß Fix critical issues first');
    }
    if (warnings.length > 0) {
      console.log('  ‚ö†Ô∏è Address warnings for better stability');
    }
    console.log('  üìù Check server logs for more details');
    console.log('  üîÑ Restart server if needed');
  }
  
  console.log('\n' + '='.repeat(50));
}

comprehensiveAnalysis().catch(console.error); 